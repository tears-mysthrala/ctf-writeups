# SSRF DNS Rebinding Challenge - Solution Guide

## Challenge Overview
- **Target**: `/admin` endpoint (only accessible from localhost)
- **Flag Location**: Admin user's profile description
- **Vulnerability**: TOCTOU (Time-of-Check-Time-of-Use) in DNS resolution

## The Vulnerability

In `app.py:148-169`:
```python
new_pp_url = request.form.get("pp-url")
if new_pp_url:
    fqdn = urlparse(new_pp_url).hostname
    ip = gethostbyname(fqdn)              # 1st DNS lookup
    if is_valid_ip(ip):                    # Check: must be public IP
        new_pp_b64 = get_pp(new_pp_url, fqdn, ip)
```

In `get_pp()` function (app.py:92-105):
```python
def get_pp(pp_url, fqdn, ip):
    with open("./logs/audit-pp-urls.log", "a") as logfile:
        pp_url_ip = pp_url.replace(fqdn, ip)
        logfile.write(f"[{now}] {pp_url_ip}\n")
        time.sleep(0.5)                    # 0.5 second delay!

    response = rqst.get(pp_url, timeout=10)  # 2nd DNS lookup
    return b64encode(response.content).decode('utf8')
```

**Attack Window**: 0.5 seconds between DNS checks

## DNS Rebinding Attack

### How It Works
1. First DNS query → Returns public IP (8.8.8.8) → Passes validation ✓
2. **0.5 second delay** → DNS TTL expires
3. Second DNS query → Returns 127.0.0.1 → Accesses /admin ✓
4. Admin page content stored as profile picture (base64)
5. Extract flag from profile

### Required DNS Rebinding Service
Format: `{unique_id}.{ip1_hex}.{ip2_hex}.rbndr.us`
- `7f000001` = 127.0.0.1 (localhost)
- `08080808` = 8.8.8.8 (public IP)
- Example: `abc123.7f000001.08080808.rbndr.us`

## Current Status

### ✅ Completed
- [x] Vulnerability identified
- [x] Exploit code written and tested
- [x] Alternative bypasses tested (all blocked correctly)
- [x] Multiple exploit variants created

### ❌ Blocker
- [ ] DNS rebinding services (rbndr.us, rebind.network) not accessible
- [ ] Network blocking SERVFAIL on all DNS rebinding queries
- [ ] VPN access restricted
- [ ] Sudo access needed for local DNS server

## Solutions

### Option 1: Manual Flag Retrieval (If You Have Access)

If you can access the challenge from a different network where DNS rebinding works:

```bash
cd ~/ctf/rootme
python3 exploit_multi.py
```

### Option 2: Local DNS Server Setup (Requires Sudo)

1. Run the DNS rebinding server:
```bash
sudo python3 dns_rebind_server.py
```

2. Configure system to use it:
```bash
# Add to /etc/resolv.conf
nameserver 127.0.0.1:5353
```

3. Run exploit with custom domain pointing to your DNS server

### Option 3: Alternative Network

Try from:
- Different WiFi network
- Mobile hotspot
- Cloud VPS (AWS/DigitalOcean)
- Friend's network

### Option 4: Report to Root-me

If this is a platform issue, contact Root-me support:
- DNS rebinding services may be blocked by platform
- They may provide alternative access method
- Challenge might need updating

## Exploit Files Created

1. `exploit_multi.py` - Multi-service DNS rebinding (main exploit)
2. `exploit_final.py` - Rate-limited parallel version
3. `exploit_custom_dns.py` - Uses Google DNS (8.8.8.8)
4. `exploit_bypass.py` - Tests alternative SSRF bypasses
5. `dns_rebind_server.py` - Local DNS rebinding server

## Expected Result

When successful, output will be:
```
[!!!] SUCCESS at attempt XX!
======================================================================
FLAG: RM{...}
======================================================================
```

The flag format is `RM{...}` and will be in the admin's profile description.

## Technical Notes

### Tested Bypasses (All Failed)
- ✗ IPv6 localhost (`[::1]`, `[::ffff:127.0.0.1]`)
- ✗ Octal IP (`0177.0.0.1`)
- ✗ Hex IP (`0x7f.0.0.1`)
- ✗ Decimal IP (`2130706433`)
- ✗ URL tricks (`@`, `#`, etc.)
- ✗ Direct localhost access

### DNS Services Tested
- ✗ rbndr.us (SERVFAIL)
- ✗ rebind.network (NXDOMAIN)
- ✗ 1u.ms (only returns localhost)
- ✓ localtest.me (works but always localhost)
- ✓ nip.io (works but no rebinding)

### Network Diagnostics
```
DNS Query: rbndr.us domains
├─ System DNS: [Errno -3] Temporary failure
├─ Google DNS (8.8.8.8): SERVFAIL
└─ Cloudflare DNS (1.1.1.1): SERVFAIL
```

This indicates either:
1. rbndr.us service is currently down
2. Network firewall blocking DNS rebinding
3. ISP-level filtering

## Next Steps

1. **Try different network**: Most likely to succeed
2. **Wait for rbndr.us**: Service may be temporarily down
3. **Contact Root-me**: Ask about recommended DNS rebinding service
4. **Setup local server**: If you can get sudo access

---

*Generated by Claude Code - CTF Challenge Analysis*
